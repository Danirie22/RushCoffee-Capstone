import React, { useState, useMemo } from 'react';
import { useNavigate } from 'react-router-dom';
import { X, Search, Plus, Minus, Trash2, User, CreditCard, AlertCircle, ShoppingCart } from 'lucide-react';
import { useProduct } from '../../context/ProductContext';
import { useAuth } from '../../context/AuthContext';
import { Product, ProductSize } from '../../data/mockProducts';
import ProductCustomizeModal from '../../components/menu/ProductCustomizeModal';
import ProductCard from '../../components/menu/ProductCard';
import PaymentModal from '../../components/employee/PaymentModal';
import { saveOrder, generateOrderNumber, OrderItem } from '../../services/orderService';

interface CartItem {
    product: Product;
    size: ProductSize;
    quantity: number;
    customizations?: any;
}

interface POSPageProps { }

const POSPage: React.FC<POSPageProps> = () => {
    const navigate = useNavigate();
    const { products, isLoading } = useProduct();
    const { currentUser } = useAuth();

    // State
    const [selectedCategory, setSelectedCategory] = useState<string>('all');
    const [searchQuery, setSearchQuery] = useState('');
    const [cart, setCart] = useState<CartItem[]>([]);
    const [customizeModalOpen, setCustomizeModalOpen] = useState(false);
    const [paymentModalOpen, setPaymentModalOpen] = useState(false);
    const [selectedProduct, setSelectedProduct] = useState<Product | null>(null);
    const [showCart, setShowCart] = useState(false);
    const [isSavingOrder, setIsSavingOrder] = useState(false);

    // Categories
    const categories = ['all', 'Coffee Based', 'Non-Coffee Based', 'Matcha Series', 'Refreshments', 'Meals'];

    // Filtered products
    const filteredProducts = useMemo(() => {
        let result = products;

        // Category filter
        if (selectedCategory !== 'all') {
            result = result.filter(p => p.category === selectedCategory);
        }

        // Search filter
        if (searchQuery.trim()) {
            result = result.filter(p =>
                p.name.toLowerCase().includes(searchQuery.toLowerCase())
            );
        }

        return result;
    }, [products, selectedCategory, searchQuery]);

    // Cart functions
    const addToCart = (product: Product, size: ProductSize, customizations?: any, quantity: number = 1) => {
        setCart(prev => {
            const existingIndex = prev.findIndex(
                item => item.product.id === product.id && item.size.name === size.name
            );

            if (existingIndex >= 0) {
                const updated = [...prev];
                updated[existingIndex].quantity += quantity;
                return updated;
            }

            return [...prev, { product, size, quantity, customizations }];
        });
    };

    const updateCartQuantity = (index: number, delta: number) => {
        setCart(prev => {
            const updated = [...prev];
            updated[index].quantity += delta;
            if (updated[index].quantity <= 0) {
                updated.splice(index, 1);
            }
            return updated;
        });
    };

    const removeFromCart = (index: number) => {
        setCart(prev => prev.filter((_, i) => i !== index));
    };

    const clearCart = () => {
        setCart([]);
    };

    // Calculate totals
    const subtotal = cart.reduce((sum, item) => sum + (item.size.price * item.quantity), 0);

    const handleConfirmCustomization = (customizations: any, quantity: number) => {
        if (selectedProduct) {
            const defaultSize = selectedProduct.sizes[0];
            addToCart(selectedProduct, defaultSize, customizations, quantity);
            setCustomizeModalOpen(false);
        }
    };

    const handleCheckout = () => {
        if (cart.length > 0) {
            setPaymentModalOpen(true);
        }
    };

    const handlePaymentComplete = async (paymentDetails: any) => {
        setIsSavingOrder(true);

        try {
            // Generate order number
            const orderNumber = await generateOrderNumber();

            // Transform cart items to order items
            const orderItems: OrderItem[] = cart.map(item => ({
                productId: item.product.id,
                productName: item.product.name,
                category: item.product.category,
                size: item.size.name,
                sizeLabel: item.size.size,
                price: item.size.price,
                quantity: item.quantity,
                customizations: item.customizations,
            }));

            // Prepare order data
            const orderData = {
                orderNumber,
                items: orderItems,
                subtotal,
                paymentMethod: paymentDetails.method as 'cash' | 'gcash',
                paymentDetails: {
                    amountReceived: paymentDetails.amountReceived,
                    change: paymentDetails.change,
                    referenceNumber: paymentDetails.referenceNumber,
                },
                status: 'preparing' as const,
                employeeId: currentUser?.uid || 'unknown',
                employeeName: currentUser?.displayName || currentUser?.email || 'Employee',
            };

            // Save to Firestore
            const orderId = await saveOrder(orderData);

            console.log('✅ Order saved successfully!', { orderId, orderNumber });

            // Clear cart and close modals
            setCart([]);
            setPaymentModalOpen(false);
            setShowCart(false);

            // Show success with order number
            alert(
                `✅ Payment Successful!\n\n` +
                `Order Number: ${orderNumber}\n` +
                `Change: ₱${paymentDetails.change.toFixed(2)}\n\n` +
                `Order has been sent to the queue!`
            );

        } catch (error) {
            console.error('❌ Error saving order:', error);
            alert('⚠️ Payment received but failed to save order. Please contact support.');
        } finally {
            setIsSavingOrder(false);
        }
    };
    { cat === 'all' ? 'All Products' : cat }
                            </button >
                        ))}
                    </div >
                </div >
            </div >

    {/* Main Content Area */ }
    < div className = "flex-1 flex overflow-hidden relative" >

        {/* Center - Products Grid */ }
        < div className = "flex-1 overflow-y-auto p-4 md:p-6 bg-gray-50 scroll-smooth" >
            {/* Products Grid - Optimized for tablet landscape */ }
{
    isLoading ? (
        <div className="flex items-center justify-center h-64">
            <div className="animate-spin h-16 w-16 border-4 border-coffee-600 border-t-transparent rounded-full"></div>
        </div>
    ) : (
        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 md:gap-5 lg:gap-6 pb-6">
            {filteredProducts.map(product => (
                <ProductCard
                    key={product.id}
                    product={product}
                    onAddToCart={(product, selectedSize) => {
                        setSelectedProduct(product);
                        setCustomizeModalOpen(true);
                    }}
                    isLoggedIn={true}
                    hideBuyNow={true}
                />
            ))}
        </div>
    )
}
                </div >

    {/* Right Sidebar - Cart */ }
{/* Overlay backdrop for mobile only */ }
{
    showCart && (
        <div
            className="fixed inset-0 bg-black/50 z-30 md:hidden backdrop-blur-sm"
            onClick={() => setShowCart(false)}
        />
    )
}

{/* Sidebar Content - Always visible on tablet landscape (md+) */ }
<div className={`
                    fixed inset-y-0 right-0 z-40 w-full sm:w-96 md:w-80 lg:w-96 bg-white shadow-2xl transform transition-transform duration-300 ease-in-out flex flex-col
                    md:relative md:translate-x-0 md:shadow-lg md:border-l md:border-gray-200
                    ${showCart ? 'translate-x-0' : 'translate-x-full md:translate-x-0'}
                `}>
    {/* Cart Header */}
    <div className="p-5 border-b border-gray-100 bg-gray-50/50 shrink-0">
        <div className="flex items-center justify-between mb-1">
            <h2 className="font-bold text-gray-900 text-xl">Current Order</h2>
            <div className="flex items-center gap-2">
                {cart.length > 0 && (
                    <button
                        onClick={clearCart}
                        className="text-red-500 hover:text-red-700 text-xs font-bold uppercase tracking-wide px-2 py-1 rounded hover:bg-red-50 transition-colors"
                    >
                        Clear All
                    </button>
                )}
                <button
                    onClick={() => setShowCart(false)}
                    className="h-8 w-8 rounded-lg hover:bg-gray-100 flex items-center justify-center"
                >
                    <X className="h-5 w-5" />
                </button>
            </div>
        </div>
        <p className="text-sm text-gray-500 font-medium">{cart.length} items added</p>
    </div>

    {/* Cart Items */}
    <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-white">
        {cart.length === 0 ? (
            <div className="flex flex-col items-center justify-center h-full text-center py-12 opacity-60">
                <div className="h-20 w-20 rounded-full bg-gray-100 flex items-center justify-center mb-4">
                    <AlertCircle className="h-10 w-10 text-gray-400" />
                </div>
                <p className="text-gray-900 font-semibold text-lg">Cart is empty</p>
                <p className="text-gray-500 text-sm mt-1 max-w-[200px]">Select items from the menu to start an order</p>
            </div>
        ) : (
            cart.map((item, index) => (
                <div key={index} className="bg-white rounded-2xl p-3 border border-gray-100 shadow-sm hover:shadow-md transition-shadow group">
                    <div className="flex items-start gap-3">
                        <div className="h-16 w-16 rounded-xl overflow-hidden bg-gray-100 flex-shrink-0">
                            <img
                                src={item.product.imageUrl}
                                alt={item.product.name}
                                className="w-full h-full object-cover"
                            />
                        </div>
                        <div className="flex-1 min-w-0 pt-0.5">
                            <h3 className="font-bold text-gray-900 text-sm leading-tight mb-1">{item.product.name}</h3>
                            <div className="flex items-center gap-2 text-xs text-gray-500 mb-2">
                                <span className="bg-gray-100 px-2 py-0.5 rounded text-gray-600 font-medium">{item.size.name}</span>
                                <span>{item.size.size}</span>
                            </div>
                            <div className="flex items-center justify-between">
                                <p className="text-sm font-bold text-coffee-700">₱{item.size.price}</p>

                                {/* Quantity Controls - Compact */}
                                <div className="flex items-center gap-3 bg-gray-50 rounded-lg p-1">
                                    <button
                                        onClick={() => updateCartQuantity(index, -1)}
                                        className="h-6 w-6 rounded-md bg-white shadow-sm hover:bg-gray-100 flex items-center justify-center text-gray-600 transition-colors"
                                    >
                                        <Minus className="h-3 w-3" />
                                    </button>
                                    <span className="w-4 text-center font-bold text-sm text-gray-900">{item.quantity}</span>
                                    <button
                                        onClick={() => updateCartQuantity(index, 1)}
                                        className="h-6 w-6 rounded-md bg-coffee-600 shadow-sm hover:bg-coffee-700 text-white flex items-center justify-center transition-colors"
                                    >
                                        <Plus className="h-3 w-3" />
                                    </button>
                                </div>
                            </div>
                        </div>
                        <button
                            onClick={() => removeFromCart(index)}
                            className="flex-shrink-0 h-7 w-7 rounded-lg text-gray-400 hover:bg-red-50 hover:text-red-500 flex items-center justify-center transition-colors opacity-0 group-hover:opacity-100"
                        >
                            <Trash2 className="h-4 w-4" />
                        </button>
                    </div>
                </div>
            ))
        )}
    </div>

    {/* Cart Footer */}
    {cart.length > 0 && (
        <div className="p-5 border-t border-gray-100 bg-gray-50 space-y-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] shrink-0">
            {/* Subtotal */}
            <div className="flex items-center justify-between">
                <span className="text-gray-600 font-medium">Subtotal</span>
                <span className="font-bold text-gray-900 text-xl">₱{subtotal.toFixed(2)}</span>
            </div>

            {/* Customer Options */}
            <button className="w-full py-3 border border-dashed border-gray-300 rounded-xl hover:border-coffee-500 hover:bg-coffee-50/50 transition-all text-sm font-semibold text-gray-500 hover:text-coffee-700 flex items-center justify-center gap-2 group">
                <User className="h-4 w-4 group-hover:scale-110 transition-transform" />
                Link Customer (Optional)
            </button>

            {/* Checkout Button */}
            <button
                onClick={handleCheckout}
                disabled={isSavingOrder}
                className="w-full py-4 bg-gradient-to-r from-coffee-600 to-coffee-800 hover:from-coffee-700 hover:to-coffee-900 text-white font-bold rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
            >
                <CreditCard className="h-5 w-5" />
                <span className="text-lg">Pay ₱{subtotal.toFixed(2)}</span>
            </button>
        </div>
    )}
</div>
            </div >

    {/* Customization Modal */ }
{
    selectedProduct && (
        <ProductCustomizeModal
            product={selectedProduct}
            selectedSize={selectedProduct.sizes[0]}
            isOpen={customizeModalOpen}
            onClose={() => setCustomizeModalOpen(false)}
            onConfirm={handleConfirmCustomization}
        />
    )
}

{/* Payment Modal */ }
<PaymentModal
    isOpen={paymentModalOpen}
    onClose={() => setPaymentModalOpen(false)}
    totalAmount={subtotal}
    onPaymentComplete={handlePaymentComplete}
/>
        </div >
    );
};

export default POSPage;
