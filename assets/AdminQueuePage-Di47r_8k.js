import{r as u,n as L,m as R,ac as D,d as p,j as e,i as I,C as S,W as U,y as x}from"./index-hoivcvTL.js";import{D as $}from"./DigitalReceipt-CedNdiYu.js";import{B as T}from"./Button-9eR8SiQT.js";import{d as F}from"./inventoryDeduction-BHKIcWK7.js";import{C as B}from"./clock-BCv6gmpA.js";import{C as P}from"./coffee-ynXiYka4.js";import{F as z}from"./file-text-B_KEMIjR.js";const J=()=>{const[v,A]=u.useState([]),[w,E]=u.useState(!0),[h,N]=u.useState(null),{showToast:j}=L(),{products:C}=R(),g=D.useRef(0);u.useEffect(()=>{const q=()=>{new Audio("data:audio/mp3;base64,//NExAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//NExAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq").play().catch(()=>{}),document.removeEventListener("click",q),document.removeEventListener("touchstart",q)};return document.addEventListener("click",q),document.addEventListener("touchstart",q),()=>{document.removeEventListener("click",q),document.removeEventListener("touchstart",q)}},[]),u.useEffect(()=>{const q=p.collection("orders").orderBy("timestamp","desc").limit(100).onSnapshot(a=>{const l=a.docs.map(c=>{var s;const r=c.data();return{id:c.id,...r,orderItems:r.orderItems||r.items||[],timestamp:(s=r.timestamp)!=null&&s.toDate?r.timestamp.toDate():r.timestamp?new Date(r.timestamp):new Date}});l.length>g.current&&g.current!==0&&new Audio("data:audio/mp3;base64,//NExAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//NExAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq").play().catch(r=>console.log("Audio play failed:",r)),g.current=l.length,A(l),E(!1)});return()=>q()},[]);const y=async(q,a,l)=>{try{const c={status:a,updatedAt:new Date};if(l&&(c.cancellationReason=l),a==="ready"){const r=await p.collection("orders").doc(q).get();if(r.exists){const s=r.data();if(s!=null&&s.inventoryDeducted)console.log(`â„¹ï¸ Inventory already deducted for order ${q}. Skipping.`);else if(s&&s.orderItems){console.log(`ðŸ“‰ Deducting inventory for order ${q} (Status: Ready)`);try{await F(s.orderItems),c.inventoryDeducted=!0}catch(n){console.error("âš ï¸ Failed to deduct inventory:",n)}}}}if(await p.collection("orders").doc(q).update(c),a==="completed"){const r=await p.collection("orders").doc(q).get();if(r.exists){const s=r.data();if(s&&s.userId){let n=0;const t=s.orderItems||s.items||[],d=[];if(t.forEach(o=>{d.push(o.productName);const i=o.productName.toLowerCase();i.includes("grande")?n+=4*o.quantity:i.includes("venti")?n+=5*o.quantity:i.includes("ala carte")?n+=4*o.quantity:i.includes("combo")&&(n+=5*o.quantity)}),n>0){const o={id:`rh-${Date.now()}`,type:"earned",points:n,description:`Earned from ${d.join(", ")}`,date:new Date};let i=s.totalAmount||s.subtotal||0;!i&&t.length>0&&(i=t.reduce((m,f)=>m+f.price*f.quantity,0),console.log(`âš ï¸ Calculated total from items: ${i}`)),console.log(`ðŸ’° Updating totalSpent for user ${s.userId} by adding ${i}`),await p.collection("users").doc(s.userId).update({totalOrders:x.firestore.FieldValue.increment(1),currentPoints:x.firestore.FieldValue.increment(n),loyaltyPoints:x.firestore.FieldValue.increment(n),totalSpent:x.firestore.FieldValue.increment(i),rewardsHistory:x.firestore.FieldValue.arrayUnion(o)}),console.log(`ðŸŒŸ Awarded ${n} points to user ${s.userId}`)}}}}j(`Order updated to ${a}`)}catch(c){console.error("Error updating order status:",c),j("Failed to update order status")}},k=q=>{if(window.confirm("Are you sure you want to cancel this order?")){const a=window.prompt("Please enter a reason for cancellation (optional):","Out of Stock");y(q,"cancelled",a||"No reason provided")}},O=q=>v.filter(a=>a.status===q).sort((a,l)=>a.timestamp.getTime()-l.timestamp.getTime()),b=({title:q,status:a,icon:l,color:c,nextStatus:r,actionLabel:s})=>{const n=O(a);return e.jsxs("div",{className:"flex flex-col h-full bg-gray-50 rounded-lg p-4 border border-gray-200",children:[e.jsxs("div",{className:`flex items-center gap-2 mb-4 pb-2 border-b-2 ${c}`,children:[e.jsx(l,{className:"h-5 w-5 text-gray-700"}),e.jsx("h2",{className:"font-bold text-gray-700",children:q}),e.jsx("span",{className:"ml-auto bg-white px-2 py-0.5 rounded-full text-xs font-bold shadow-sm border",children:n.length})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto space-y-3 pr-1",children:[n.map((t,d)=>e.jsxs(S,{className:"p-3 shadow-sm hover:shadow-md transition-shadow bg-white",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-bold text-lg",children:t.orderNumber}),e.jsx("p",{className:"text-xs text-gray-500",children:t.customerName})]}),e.jsx("span",{className:"text-xs text-gray-400",children:t.timestamp.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]}),e.jsx("div",{className:"mb-2",children:t.orderType==="online"?e.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800",children:"ðŸŒ Online"}):e.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800",children:"ðŸª Walk-in"})}),e.jsx("div",{className:"space-y-2 mb-3",children:(t.orderItems||[]).map((o,i)=>{const m=C.find(f=>f.id===o.productId);return e.jsxs("div",{className:"text-sm flex items-center gap-3 bg-gray-50 p-2 rounded-lg",children:[(m==null?void 0:m.imageUrl)&&e.jsx("img",{src:m.imageUrl,alt:o.productName,className:"h-10 w-10 rounded-md object-cover flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("span",{className:"font-medium text-gray-900 truncate",children:o.productName}),e.jsxs("span",{className:"text-xs font-bold bg-white px-1.5 py-0.5 rounded border ml-2",children:["x",o.quantity]})]}),o.size&&e.jsx("p",{className:"text-xs text-gray-500",children:o.size})]})]},i)})}),t.paymentMethod==="gcash"&&e.jsxs("div",{className:"mt-2 mb-2 rounded bg-blue-50 p-2 text-xs text-blue-800 border border-blue-100",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"font-bold flex items-center gap-1",children:[e.jsx("span",{className:"h-2 w-2 rounded-full bg-blue-500"}),"GCash"]}),t.receiptUrl&&e.jsxs("button",{onClick:()=>N(t),className:"flex items-center gap-1 text-blue-600 hover:text-blue-800 hover:underline font-medium",children:[e.jsx(z,{className:"h-3 w-3"}),"View Receipt"]})]}),t.paymentAccountName&&e.jsxs("div",{className:"mt-1 font-medium truncate",title:t.paymentAccountName,children:["Acct: ",t.paymentAccountName]}),t.paymentReference&&e.jsxs("div",{className:"mt-1 font-mono truncate",title:t.paymentReference,children:["Ref: ",t.paymentReference]})]}),e.jsxs("div",{className:"flex gap-2 mt-2",children:[a==="waiting"&&e.jsx("button",{onClick:()=>k(t.id),className:"p-1.5 text-red-500 hover:bg-red-50 rounded-md transition-colors",title:"Cancel Order",children:e.jsx(U,{className:"h-4 w-4"})}),r&&e.jsx(T,{size:"sm",className:`w-full flex items-center justify-center gap-1 ${a==="waiting"&&d!==0?"bg-gray-600 hover:bg-gray-700":""}`,onClick:()=>{a==="waiting"&&d!==0?window.confirm(`âš ï¸ Are you sure you want to skip the previous ${d} order(s)?

It is recommended to serve orders in sequence.`)&&y(t.id,r):y(t.id,r)},title:a==="waiting"&&d!==0?"Click to skip previous orders":"",children:s||"Next"})]})]},t.id)),n.length===0&&e.jsx("div",{className:"text-center py-8 text-gray-400 text-sm italic",children:"No orders"})]})]})};return w?e.jsx("div",{className:"flex h-full items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600"})}):e.jsxs("div",{className:"h-[calc(100vh-100px)] flex flex-col",children:[e.jsxs("div",{className:"mb-6 flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Queue Management"}),e.jsx("p",{className:"text-gray-500",children:"Real-time kitchen display system"})]}),e.jsx("div",{className:"flex gap-4 text-sm",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-green-500"}),e.jsx("span",{children:"Connected"})]})})]}),e.jsxs("div",{className:"flex-1 grid grid-cols-1 md:grid-cols-3 gap-6 overflow-hidden",children:[e.jsx(b,{title:"Waiting",status:"waiting",icon:B,color:"border-gray-400",nextStatus:"preparing",actionLabel:"Start Preparing"}),e.jsx(b,{title:"Preparing",status:"preparing",icon:P,color:"border-yellow-400",nextStatus:"ready",actionLabel:"Mark Ready"}),e.jsx(b,{title:"Ready to Serve",status:"ready",icon:I,color:"border-green-400",nextStatus:"completed",actionLabel:"Complete Order"})]}),h&&e.jsx($,{order:h,isOpen:!!h,onClose:()=>N(null)})]})};export{J as default};
